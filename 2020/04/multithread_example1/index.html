<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.55.6 with theme Tranquilpeak 0.4.7-BETA">
<meta name="author" content="ÊÄ†ÊÉ∞„Å™„É¶„Éã„Ç≥„Éº„É≥ü¶Ñ">
<meta name="keywords" content="tech, C, C&#43;&#43;, PAT">
<meta name="description" content="">


<meta property="og:description" content="">
<meta property="og:type" content="article">
<meta property="og:title" content="Multithread_example1">
<meta name="twitter:title" content="Multithread_example1">
<meta property="og:url" content="https://gmtcover.github.io/2020/04/multithread_example1/">
<meta property="twitter:url" content="https://gmtcover.github.io/2020/04/multithread_example1/">
<meta property="og:site_name" content="ÊÄ†ÊÉ∞„Å™„É¶„Éã„Ç≥„Éº„É≥ü¶Ñ">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:locale" content="zh-cn">

  
    <meta property="article:published_time" content="2020-04-08T15:18:48">
  
  
    <meta property="article:modified_time" content="2020-04-08T15:18:48">
  
  
  
    
      <meta property="article:section" content="CÁ®ãÂ∫èËÆæËÆ°">
    
      <meta property="article:section" content="Multithreading">
    
  
  
    
      <meta property="article:tag" content="c">
    
  


<meta name="twitter:card" content="summary">











  <meta property="og:image" content="https://gmtcover.github.io/images/touxiang.png">
  <meta property="twitter:image" content="https://gmtcover.github.io/images/touxiang.png">


    <title>Multithread_example1</title>

    <link rel="icon" href="https://gmtcover.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://gmtcover.github.io/2020/04/multithread_example1/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://gmtcover.github.io/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://gmtcover.github.io/">ÊÄ†ÊÉ∞„Å™„É¶„Éã„Ç≥„Éº„É≥ü¶Ñ</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://gmtcover.github.io/#about">
    
    
    
      
        <img class="header-picture" src="https://gmtcover.github.io/images/touxiang.png" alt="‰ΩúËÄÖÁöÑÂõæÁâá" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://gmtcover.github.io/#about">
          <img class="sidebar-profile-picture" src="https://gmtcover.github.io/images/touxiang.png" alt="‰ΩúËÄÖÁöÑÂõæÁâá" />
        </a>
        <h4 class="sidebar-profile-name">ÊÄ†ÊÉ∞„Å™„É¶„Éã„Ç≥„Éº„É≥ü¶Ñ</h4>
        
          <h5 class="sidebar-profile-bio">Now or never! FocusÔºåfunÔºÅ</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://gmtcover.github.io/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">È¶ñÈ°µ</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://gmtcover.github.io/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Á±ªÂà´</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://gmtcover.github.io/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Ê†áÁ≠æ</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://gmtcover.github.io/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">ÂΩíÊ°£</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://gmtcover.github.io/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">ÂÖ≥‰∫é</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/gmTcover" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://gmtcover.github.io/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Multithread_example1
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2020-04-08T15:18:48&#43;09:00">
        
  ÂõõÊúà 8, 2020

      </time>
    
    
  
  
    <span>ÂèëÂ∏ÉÂú®</span>
    
      <a class="category-link" href="https://gmtcover.github.io/categories/c%e7%a8%8b%e5%ba%8f%e8%ae%be%e8%ae%a1">CÁ®ãÂ∫èËÆæËÆ°</a>, 
    
      <a class="category-link" href="https://gmtcover.github.io/categories/multithreading">Multithreading</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <h4 id="parameter-arguments">parameter/arguments</h4>

<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;pthread.h&gt;
int arr[5000];
// args
typedef struct {
    int first;
    int last;
    int ret;
} MY_ARGS;
void* myfunc(void* args) {
    int i;
    int sum = 0;
    MY_ARGS* my_args = (MY_ARGS*) args;
    int first = my_args -&gt; first;
    int last = my_args -&gt; last;
    for (i=first; i&lt;last; i++) {
        sum += arr[i];
    }
    my_args -&gt; ret = sum;
    return NULL;
}
int main() {
    //initialize array
    int i;
    for (i=0; i&lt;5000; i++) {
        arr[i] = rand()%50;
    }

    MY_ARGS args1 ={0,2500, 0};
    MY_ARGS args2 ={2500,5000, 0};
    pthread_t th1;
    pthread_t th2;

    pthread_create(&amp;th1, NULL, myfunc, &amp;args1);
    pthread_create(&amp;th2, NULL, myfunc, &amp;args2);

    pthread_join(th1, NULL);
    pthread_join(th2, NULL);
    
    int s1 = args1.ret;
    printf(&quot;%d\n&quot;,s1);
    int s2 = args2.ret;
    printf(&quot;%d\n&quot;,s2);
    printf(&quot;s1 + s2 = %d&quot;, s1 + s2);
    printf(&quot;Hello World!&quot;);

    return 0;
}
</code></pre>

<h4 id="global-variable">global variable</h4>

<pre><code>int arr[5000];
typedef struct {
    int first;
    int last;
    //int ret;
} MY_ARGS;

int s = 0;// risk

void* myfunc(void* args) {
    int i;
    MY_ARGS* tmp = (MY_ARGS*) args;
    int first = tmp -&gt; first;
    int last = tmp -&gt; last;
    for (i=first; i&lt;last; i++) {
        s += arr[i];
    }
    return NULL;
}
int main() {
    int i;
    for (i=0; i&lt;5000; i++) {
        arr[i] = rand()%50;
    }

    MY_ARGS args1 ={0,2500};
    MY_ARGS args2 ={2500,5000};
    pthread_t th1;
    pthread_t th2;

    pthread_create(&amp;th1, NULL, myfunc, &amp;args1);
    pthread_create(&amp;th2, NULL, myfunc, &amp;args2);

    pthread_join(th1, NULL);
    pthread_join(th2, NULL);
    /* int s1 = args1.ret; */
    /* printf(&quot;%d\n&quot;,s1); */
    /* int s2 = args2.ret; */
    /* printf(&quot;%d\n&quot;,s2); */
    /* printf(&quot;s1 + s2 = %d&quot;, s1 + s2); */
    printf(&quot;%d\n&quot;,s);
    printf(&quot;Hello World!&quot;);
    return 0;
}

</code></pre>

<h4 id="race-condition">race condition</h4>

<ul>
<li>race condition : A race condition is an undesirable situation that occurs when a device or system attempts to perform two or more operations at the same time, but because of the nature of the device or system, the operations must be done in the proper sequence to be done correctly.</li>

<li><p>solutionÔºö mutex_lock Ôºàpthread_mutex_initÔºâ</p>

<pre><code>#include &lt;stdio.h&gt;
#include &lt;pthread.h&gt;
// s++: readÔºàsÔºâÔºås+1ÔºåwriteÔºàsÔºâ
int s = 0;
// create lock
pthread_mutex_t lock;
void* myfunc(void* args) {
int i = 0;
    pthread_mutex_lock(&amp;lock);
for (i=0; i&lt;1000000; i++) {
    //pthread_mutex_lock(&amp;lock);
    s++;
    //pthread_mutex_unlock(&amp;lock);
}
    pthread_mutex_unlock(&amp;lock);
return NULL;
}
int main() {
pthread_t th1, th2;

pthread_mutex_init(&amp;lock, NULL);
pthread_create(&amp;th1, NULL, myfunc, NULL);
pthread_create(&amp;th2, NULL, myfunc, NULL);

pthread_join(th1,NULL);
pthread_join(th2,NULL);

printf(&quot;%d\n&quot;,s);
return 0;
}
time ./example
Bug: After adding lock that's equivalent to single thread
</code></pre></li>

<li><p>Problems</p>

<ul>
<li>low efficiency</li>
<li>where we put mutex_lock</li>
</ul></li>
</ul>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">Ê†áÁ≠æ</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://gmtcover.github.io/tags/c/">c</a>

                  </div>
                
              
            
              <span id="https://gmtcover.github.io/2020/04/multithread_example1/" class="leancloud_visitors" data-flag-title="Multithread_example1">
                <span class="post-meta-item-text">ÊñáÁ´†ÈòÖËØªÈáè </span>
                <span class="leancloud-visitors-count">1000000</span>
                <p></p>
              </span>
              <div id="vcomments"></div>
              <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
              <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
              <script type="text/javascript">
                new Valine({
                  el: '#vcomments' ,
                  appId: 'KgLE9jnxcE9p8kIUxdyeKXSy-gzGzoHsz',
                  appKey: '7AEwN7e46mj0dXeX2p700XUX',
                  notify: 'false',
                  verify: '',
                  avatar:'mp', 
                  placeholder: 'ËØ¥ÁÇπ‰ªÄ‰πàÂêß',
                  visitor: 'true'
                });
              </script>
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://gmtcover.github.io/2020/04/multithreading/" data-tooltip="Multithreading">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">‰∏ä‰∏ÄÁØá</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://gmtcover.github.io/2020/04/multithread_example2/" data-tooltip="Multithread_example2">
              
                  <span class="hide-xs hide-sm text-small icon-mr">‰∏ã‰∏ÄÁØá</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2021 ÊÄ†ÊÉ∞„Å™„É¶„Éã„Ç≥„Éº„É≥ü¶Ñ. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://gmtcover.github.io/2020/04/multithreading/" data-tooltip="Multithreading">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">‰∏ä‰∏ÄÁØá</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://gmtcover.github.io/2020/04/multithread_example2/" data-tooltip="Multithread_example2">
              
                  <span class="hide-xs hide-sm text-small icon-mr">‰∏ã‰∏ÄÁØá</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://gmtcover.github.io/images/touxiang.png" alt="‰ΩúËÄÖÁöÑÂõæÁâá" />
    
    <h4 id="about-card-name">ÊÄ†ÊÉ∞„Å™„É¶„Éã„Ç≥„Éº„É≥ü¶Ñ</h4>
    
      <div id="about-card-bio">Now or never! FocusÔºåfunÔºÅ</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        „Éº„ÄÇ„Éº
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        „Éº„ÄÇ„Éº
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://gmtcover.github.io/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://gmtcover.github.io/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


  
    <script src="https://gmtcover.github.io/js/clicklove.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/gmtcover.github.io\/2020\/04\/multithread_example1\/';
          
            this.page.identifier = '\/2020\/04\/multithread_example1\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'valine';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

